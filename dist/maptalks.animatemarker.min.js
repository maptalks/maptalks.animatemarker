/*!
 * maptalks.animatemarker v0.4.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
/*!
 * requires maptalks@>=0.25.0 
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],t):t(e.maptalks=e.maptalks||{},e.maptalks)}(this,function(e,t){"use strict";function r(e,t){for(var r=Object.getOwnPropertyNames(t),n=0;n<r.length;n++){var a=r[n],o=Object.getOwnPropertyDescriptor(t,a);o&&o.configurable&&void 0===e[a]&&Object.defineProperty(e,a,o)}return e}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):r(e,t))}function i(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}var s={markerType:"ellipse",markerFill:function(e){return{type:"radial",colorStops:[[.7,"rgba("+e.join()+", 0.5)"],[.3,"rgba("+e.join()+", 1)"],[.2,"rgba("+e.join()+", 1)"],[0,"rgba("+e.join()+", 0)"]]}}([135,196,240]),markerFillOpacity:.8,markerLineWidth:0,markerWidth:16,markerHeight:16},p=function(e){function r(){return n(this,r),a(this,e.apply(this,arguments))}return o(r,e),r.prototype.addGeometry=function(r){return r instanceof t.Geometry&&(r=[r]),r.forEach(function(e,r){if(!(e instanceof t.Marker))throw new Error("The geometry at "+r+" to add is not a maptalks.Marker")}),e.prototype.addGeometry.apply(this,arguments)},r.fromJSON=function(e){if(!e||"AnimateMarkerLayer"!==e.type)return null;for(var n=new r(e.id,e.options),a=e.geometries,o=[],i=0;i<a.length;i++){var s=t.Geometry.fromJSON(a[i]);s&&o.push(s)}return n.addGeometry(o),e.style&&n.setStyle(e.style),n},r}(t.VectorLayer);p.mergeOptions({animation:"scale,fade",randomAnimation:!0,animationDuration:3e3}),p.registerJSONType("AnimateMarkerLayer"),p.registerRenderer("canvas",function(e){function r(){return n(this,r),a(this,e.apply(this,arguments))}return o(r,e),r.prototype.draw=function(){this._needUpdate&&(this._prepare(),this._needUpdate=!1),this.prepareCanvas();var e=this.getMap(),t=this._currentMarkers;this._drawnExtent&&e.getExtent().equals(this._drawnExtent)&&(t=this._drawnMarkers),this._drawAllMarkers(t),this._drawnExtent=e.getExtent(),this.layer.isLoaded()||this.completeRender()},r.prototype.drawOnInteracting=function(){this._drawnMarkers&&0!==this._drawnMarkers.length&&this._drawAllMarkers(this._drawnMarkers)},r.prototype.needToRedraw=function(){return!!this.layer.options.animation||e.prototype.needToRedraw.call(this)},r.prototype.onCanvasCreate=function(){this._prepare()},r.prototype.onGeometryAdd=function(){this._redraw()},r.prototype.onGeometryRemove=function(){this._redraw()},r.prototype.onGeometrySymbolChange=function(){this._redraw()},r.prototype.onGeometryPositionChange=function(){this._redraw()},r.prototype.onGeometryShow=function(){this._redraw()},r.prototype.onGeometryHide=function(){this._redraw()},r.prototype.onGeometryPropertiesChange=function(e){if(e&&this.layer.getStyle())for(var t=0;t<e.length;t++)this.layer._styleGeometry(e[t])},r.prototype._redraw=function(){delete this._drawnMarkers,delete this._drawnExtent,this._needUpdate=!0},r.prototype._drawAllMarkers=function(e){var t=this,r=this.getMap(),n=r.getContainerExtent(),a=this._drawnTime=Date.now(),o=this._drawnAnim=this._getAnimation(),i=e!==this._drawnMarkers;i&&(this._drawnMarkers=[]),e.forEach(function(e){if(i){if(e.g.isVisible()){var s=r._prjToContainerPoint(e.coordinates);n.contains(s)&&(t._drawMarker(e,s,o,a),t._drawnMarkers.push(e))}}else{var p=r._prjToContainerPoint(e.coordinates);t._drawMarker(e,p,o,a)}},this)},r.prototype._drawMarker=function(e,t,r,n){var a=this.layer.options.animationDuration,o=this.context,i=o.globalAlpha,s=(n-e.start)%a/a,p=r.fade&&s>=.5?2-2*s:1,c=r.scale?s:1,h=e.cacheKey,l=this._spriteCache[h],d=l.offset,y=l.canvas.width,f=l.canvas.height;l&&p>0&&(o.globalAlpha=i*p,o.drawImage(l.canvas,t.x+d.x-y*c/2,t.y+d.y-f*c/2,y*c,f*c),o.globalAlpha=i)},r.prototype._prepare=function(){var e=this,t=[],r={},n=this.getMap().getProjection();this.layer.forEach(function(a){e._currentGeo=a;var o=a._getInternalSymbol()===a.options.symbol?s:a._getInternalSymbol(),i=JSON.stringify(o);r[i]||(r[i]=o),t.push({coordinates:n.project(a.getCoordinates()),cacheKey:i,start:e.layer.options.randomAnimation?Math.random()*e.layer.options.animationDuration:0,g:a})}),this._prepareSprites(r),this._currentMarkers=t},r.prototype._prepareSprites=function(e){this._spriteCache={};for(var r in e){var n=e[r],a=new t.Marker([0,0],{symbol:n})._getSprite(this.resources);this._spriteCache[r]=a}},r.prototype.onRemove=function(){delete this._spriteCache,delete this._currentMarkers,delete this._drawnMarkers,delete this._drawnExtent},r.prototype._getAnimation=function(){for(var e={fade:!1,scale:!1},t=this.layer.options.animation?this.layer.options.animation.split(","):[],r=0;r<t.length;r++){var n=i(t[r]);"fade"===n?e.fade=!0:"scale"===n&&(e.scale=!0)}return e},r}(t.renderer.OverlayLayerCanvasRenderer)),e.AnimateMarkerLayer=p,Object.defineProperty(e,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.animatemarker v0.4.0, requires maptalks@>=0.25.0.")});